import os
import keep_alive
import discord
from datetime import datetime
from discord.ext import tasks
import sqlite3

dbname = 'bot.db'

conn = sqlite3.connect(dbname)
c = conn.cursor()  #DBã¸ã®æ¥ç¶š


TOKEN = '#è‡ªåˆ†ã®Botã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³'

# æ¥ç¶šã«å¿…è¦ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆ
client = discord.Client()

#tableå‰Šé™¤
c.execute("DROP TABLE IF EXISTS 'tasks'")
conn.commit()

#tableä½œæˆ
c.execute("CREATE TABLE IF NOT EXISTS 'tasks' (id value,event verchar,per verchar)")
conn.commit()

# èµ·å‹•æ™‚ã«å‹•ä½œã™ã‚‹å‡¦ç†
@client.event
async def on_ready():
	print('ready')

channel = 833974620779839498

# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã«å‹•ä½œã™ã‚‹å‡¦ç†
@client.event
async def on_message(message):
  member_mention = str(message.author.id)
  if message.author.bot:
    return
  if message.channel.id != channel:
    return
  if message.content == '/all':
    send_channel = client.get_channel(channel)
    c.execute('SELECT * FROM tasks WHERE id = ?' ,(message.author.id,))
    allevent = c.fetchall()
    count = len(allevent)
    for num in range(count):
      await send_channel.send(allevent[num][1] + '\n' + 'é€²æ—ç‡' + allevent[num][2])
    return
  c.execute("INSERT INTO tasks VALUES (:id, :event, :per)",
                   {'id': member_mention,'event': message.content, 'per' : '0%'})
  conn.commit()
  await message.add_reaction('1âƒ£')
  await message.add_reaction('2âƒ£')
  await message.add_reaction('3âƒ£')
  await message.add_reaction('4âƒ£')
  await message.add_reaction('5âƒ£')
  await message.add_reaction('6âƒ£')
  await message.add_reaction('7âƒ£')
  await message.add_reaction('8âƒ£')
  await message.add_reaction('9âƒ£')
  await message.add_reaction('ğŸ”Ÿ')
  c.execute('SELECT * FROM tasks')
  print(c.fetchall())
  if message.content == '/all':
     c.execute('SELECT * FROM tasks WHERE id = ?,member_mention')
     print(c.fetchall())

  
#ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‰ã‚ŒãŸã¨ãã«èµ°ã‚‹å‡¦ç†
@client.event
async def on_reaction_add(reaction, user):
  if user.bot:
    return
  send_channel = client.get_channel(channel)
  Event = reaction.message.content
  ID = user.id
  print(reaction)
  c.execute(
		    'SELECT * FROM tasks WHERE id = ? AND event = ?' ,(ID, Event))
  set_task = c.fetchall()
  if reaction.emoji == ("1âƒ£"):
    c.execute("update tasks set per = '10%' where event = Event")
    c.execute('SELECT * FROM tasks')
    print(Event)
    print(c.fetchall())
    await send_channel.send(set_task[0][1] + "\n" + "[â¬¢â¬¡â¬¡â¬¡â¬¡â¬¡â¬¡â¬¡â¬¡â¬¡]10%")
  if reaction.emoji == ("2âƒ£"):
    c.execute("update tasks set per = '20%' where event = Event")
    c.execute('SELECT * FROM tasks')
    print(c.fetchall())
    await send_channel.send(set_task[0][1] + "\n" + "[â¬¢â¬¢â¬¡â¬¡â¬¡â¬¡â¬¡â¬¡â¬¡â¬¡]20%")
  if reaction.emoji == ("3âƒ£"):
    c.execute("update tasks set per = '30%' where event = Event")
    c.execute('SELECT * FROM tasks')
    print(c.fetchall())
    await send_channel.send(set_task[0][1] + "\n" + "[â¬¢â¬¢â¬¢â¬¡â¬¡â¬¡â¬¡â¬¡â¬¡â¬¡]30%")
  if reaction.emoji == ("4âƒ£"):
    c.execute("update tasks set per = '40%' where event = Event")
    c.execute('SELECT * FROM tasks')
    print(c.fetchall())
    await send_channel.send(set_task[0][1] + "\n" + "[â¬¢â¬¢â¬¢â¬¢â¬¡â¬¡â¬¡â¬¡â¬¡â¬¡]40%")
  if reaction.emoji == ("5âƒ£"):
    c.execute("update tasks set per = '50%' where event = Event")
    c.execute('SELECT * FROM tasks')
    print(c.fetchall())
    await send_channel.send(set_task[0][1] + "\n" + "[â¬¢â¬¢â¬¢â¬¢â¬¢â¬¡â¬¡â¬¡â¬¡â¬¡]50%")
  if reaction.emoji == ("6âƒ£"):
    c.execute("update tasks set per = '60%' where event = Event")
    c.execute('SELECT * FROM tasks')
    print(c.fetchall())
    await send_channel.send(set_task[0][1] + "\n" + "[â¬¢â¬¢â¬¢â¬¢â¬¢â¬¢â¬¡â¬¡â¬¡â¬¡]60%")
  if reaction.emoji == ("7âƒ£"):
    c.execute("update tasks set per = '70%' where event = Event")
    c.execute('SELECT * FROM tasks')
    print(c.fetchall())
    await send_channel.send(set_task[0][1] + "\n" + "[â¬¢â¬¢â¬¢â¬¢â¬¢â¬¢â¬¢â¬¡â¬¡â¬¡]70%")
  if reaction.emoji == ("8âƒ£"):
    c.execute("update tasks set per = '80%' where event = Event")
    c.execute('SELECT * FROM tasks')
    print(c.fetchall())
    await send_channel.send(set_task[0][1] + "\n" + "[â¬¢â¬¢â¬¢â¬¢â¬¢â¬¢â¬¢â¬¢â¬¡â¬¡]80%")
  if reaction.emoji == ("9âƒ£"):
    c.execute("update tasks set per = '90%' where event = Event")
    c.execute('SELECT * FROM tasks')
    print(c.fetchall())
    await send_channel.send(set_task[0][1] + "\n" + "[â¬¢â¬¢â¬¢â¬¢â¬¢â¬¢â¬¢â¬¢â¬¢â¬¡]90%")
  if reaction.emoji == ("ğŸ”Ÿ"):
    embed=discord.Embed(description=set_task[0][1] + "ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚")
    await send_channel.send(embed=embed)
    c.execute(
		    'DELETE FROM tasks WHERE id = ? AND event = ?', (ID, Event))
    conn.commit()

  
#Botã®èµ·å‹•ã¨Discordã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶š
keep_alive.keep_alive()
client.run(os.getenv('TOKEN'))
conn.close()
